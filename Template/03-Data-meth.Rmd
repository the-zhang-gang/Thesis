---
output:
  #bookdown::html_document2: default
  #bookdown::word_document2: default
  bookdown::pdf_document2: 
    template: templates/brief_template.tex
    citation_package: biblatex
documentclass: book
bibliography: references.bib
---

# Data and methodology {#dat-and-meth}

\chaptermark{Data and methodology}

\minitoc <!-- this will include a mini table of contents-->

## Data

<!-- uncomment this codes -->

Here comes text...

```{r dataloading, include=F}
require(readxl)
require(xts)
require(PerformanceAnalytics)
require(kableExtra)
require(rugarch)

options(warn = -1, scipen = 999)
data <- read_excel("data/datastream.xlsx",col_types = c("date", rep("numeric", 6)),
                                       skip = 2)
colnames(data) <- c("Date",gsub(pattern = " ", replacement = "_",gsub(pattern = " - PRICE INDEX", replacement='' , colnames(data)[2:7])))
Price_indices <- as.xts(data[,-1], order.by = data$Date)
Estoxx <- Price_indices[,1] #see if price index
R <- diff(Estoxx, log = TRUE, na.pad = FALSE)*100

```

### Descriptives

#### Table of summary statistics

Here comes a table and description of the stats

```{r stats, echo=F, results='asis'}
Statistics <-  table.Stats(R)
Stats.names <- rownames(Statistics)[-c(1,2,4,8,10:13)]
Statistics <- Statistics[-c(1,2,4,8,10:13),] #selecting relevant columns only
names(Statistics) <- Stats.names


garchspec.R <- ugarchspec(mean.model = list(armaOrder = c(1,0)),
                     variance.model = list(model = "sGARCH", variance.targeting = F), 
                     distribution.model = "norm")
# Estimate the model
garchfit.R <- ugarchfit(data = R, spec = garchspec.R)

# Compute stdret using residuals()
stdret.R <- residuals(garchfit.R, standardize = TRUE)

Statistics.S <-  table.Stats(stdret.R)
Statistics.S <- Statistics.S[-c(1,2,4,8,10:13),] #selecting relevant columns only
names(Statistics.S) <- Stats.names



kable(cbind(Statistics, Statistics.S), caption = "Summary statistics of the returns",
      label = 'dsTable',
      booktabs = T,
      position = "h!",
      digits = 3 )%>%
  kable_classic(full_width = F)%>%
  footnote('This table shows the descriptive statistics of the returns of the 5 asset classes over the period %s to %s',
           footnote_as_chunk = T, general_title = "Note: ")

```

#### Correlation

Here comes a table and description of the correlations

```{r correlation, echo=F}
# mcor <- cor(R)
# upper <- round(mcor,3)
# library(xtable)
# upper[upper.tri(mcor)] <-""
# upper<-as.data.frame(upper)
# upper %>% kbl(format='latex',
#       caption = "Correlation table between the different blue chip indices",
#       label = 'dsTable',
#       booktabs = T,
#       position = "h!",
#       digits = 3) %>%
#   kable_classic(full_width = F) %>%
#   footnote(general = sprintf('This table shows the descriptive statistics of the returns of the %s asset classes over the period %s to %s', ncol(data), data$...1[2],data$...1[nrow(data)]),
#            footnote_as_chunk = T,
#            general_title = 'Note: ',
#            threeparttable = TRUE)
```

#### Visualizations (eye-balling)

```{r plot1, echo=F, fig.cap='Eurostoxx 50 rolling volatility'}
#par(mfrow = c(1,1))
plot(Estoxx, major.ticks = "years", grid.ticks.on = "years", col = "blue",
     main = "EuroStoxx 50 Price Index")
plot(R, major.ticks = "years", grid.ticks.on = "years", col = "blue",
     main = "EuroStoxx 50 Price Log Returns")
```

```{r plot2, echo=F}
#Histogram to eyeball normality

# h <- hist(R, breaks = 75, density = 10,
#           col = "lightgray", xlab = "Accuracy", main = "Barplot") 
# xfit <- seq(min(R), max(R), length = 40) 
# yfit <- dnorm(xfit, mean = mean(R), sd = sd(R)) 
# yfit <- yfit * diff(h$mids[1:2]) * length(R) 
# lines(xfit, yfit, col = "black", lwd = 1)

chart.Histogram(R = R, methods = "add.normal", breaks = 100, main = "Returns Histogram Vs. Normal")

#Plotting volatility

chart.RollingPerformance(R = R, width = 22,
     FUN = "sd.annualized", scale = 252, main = "One month rolling volatility")

```

As can be seen

```{r acfplots, echo=F}

# Compute the mean daily return
m <- mean(R)

# Define the series of prediction errors
e <- R - m

# Plot the absolute value of the prediction errors
par(mfrow = c(2,1),mar = c(1, 2, 2, 1))
plot(abs(e), main = "Absolute Prediction Error")

# Plot the acf of the absolute prediction errors
acf(abs(e), main = "", xaxt = "n")

# acf(coredata(R), lag = 22, main = "EuroStoxx 50 Price Log Returns")
# acf(coredata(abs(R)), lag = 22, main = "EuroStoxx 50 Absolute Price Log Returns")
```




```{r}
distributions <- c("norm", "std", "sstd", "sged", "ged")
garchspec <- garchfit <- garchforecast <- stdret <- vector(mode = "list", length = length(distributions))

for(i in 1:length(distributions)){
# Specify a GARCH model with constant mean
garchspec[[i]] <- ugarchspec(mean.model = list(armaOrder = c(1,0)),
                     variance.model = list(model = "sGARCH", variance.targeting = F), 
                     distribution.model = distributions[i])
# Estimate the model
garchfit[[i]] <- ugarchfit(data = R, spec = garchspec[[i]])

# Compute stdret using residuals()
stdret[[i]] <- residuals(garchfit[[i]], standardize = TRUE)

# Compute stdret using fitted() and sigma()
stdret[[i]] <- (R - fitted(garchfit[[i]])) / sigma(garchfit[[i]]) 

}

#  make the histogram

chart.Histogram(stdret[[1]], methods = c("add.normal","add.density" ), 
                colorset = c("gray","red","blue"))


```

\newpage

### Methodology

Here comes text...

As already mentioned in ..., GARCH models sGARCH, eGARCH, iGARCH, gjrGARCH, nGARCH, tGARCH and tsGARCH will be estimated. Additionally the distributions will be examined as well, including the normal, student-t distribution, skewed student-t distribution, generalised error distribution, skewed generalised error distribution and the skewed generalised Theodossiou distribution.

They will be estimated using maximum likelyhood. As already mentioned, fortunately, Alexios @alexios2020 has made it easy for us to implement this methodology in R (version 3.6.1) with the package rugarch version 1.4-4 (R univariate garch), which gives us a bit more time to focus on the results and the interpretation.

\clearpage

```{=html}
<!-- clearpage ends the page, and also dumps out all floats.
  Floats are things like tables and figures. -->
```
```{r citr, echo=FALSE, fig.cap="The `citr` add-in", out.width="80%", fig.align='center'}
# include dynamic gif if output is HTML; otherwise screenshot
# knitr::include_graphics("figures/sample-content/citr.png")
```

Let's add an image:

```{r captain, fig.align='center', fig.cap="A marvel-lous meme", out.width="65%"}
# knitr::include_graphics("figures/sample-content/captain.jpeg")
```
